<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Steam Game Recommender · Modi</title>
  <meta name="color-scheme" content="dark" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script>tailwind={config:{darkMode:'class',theme:{extend:{fontFamily:{sans:['Inter','ui-sans-serif','system-ui','Segoe UI','Helvetica Neue','Arial']}}}}};</script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#0b0b0e; color:#e7e7ea; }
    .card { background:#121217; border:1px solid #27272a; border-radius:1.25rem; }
    .btn { background:#5b55ee; color:#fff; }
    .btn:hover { background:#6c69f3; }
    .outline { border:1px solid #2f2f37; }
    a { color:#b8befe; }
  </style>
</head>
<body>
  <header class="sticky top-0 z-40 backdrop-blur bg-black/30 border-b border-zinc-800">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="index.html" class="font-extrabold tracking-tight text-lg">Modi</a>
      <nav class="hidden sm:flex items-center gap-6 text-sm text-zinc-400">
        <a href="index.html">Home</a>
        <a href="steam.html" class="text-zinc-200">Steam</a>
        <a href="spy.html">SPY</a>
        <a href="https://github.com/Modertool999/game-recommender" target="_blank">Repo ↗</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-10">
    <section class="card p-6">
      <h1 class="text-3xl font-bold">Steam Game Recommender</h1>
      <p class="text-sm text-zinc-300 mt-1 max-w-2xl">
        Content-based filtering over the top 20k games (TF-IDF on name/description/genres) blended with social signals (friends’ playtime & friends’ similarity).
        Paste your <strong>SteamID64</strong> and tune the three weights.
      </p>
    </section>

    <section class="mt-6 card p-6">
      <div id="alert" class="hidden mb-4 rounded-lg border border-red-800 bg-red-950/40 px-3 py-2 text-sm text-red-300"></div>

      <form id="steamForm" class="space-y-4" novalidate>
        <div class="grid md:grid-cols-3 gap-4">
          <label class="text-sm">SteamID64
            <input id="steamId" inputmode="numeric" pattern="^7656119\d{10}$"
                   class="mt-1 w-full rounded-xl outline bg-transparent px-3 py-2"
                   placeholder="7656119XXXXXXXXXX" required />
            <div class="text-xs text-zinc-400 mt-1">
              Find it at <a class="underline" href="https://steamid.io/lookup" target="_blank">steamid.io/lookup</a> → copy <em>SteamID64</em>.
            </div>
          </label>

          <label class="text-sm">Content weight (TF-IDF)
            <input id="wContent" type="range" min="0" max="1" step="0.05" value="0.60" class="mt-3 w-full" />
            <div class="text-xs text-zinc-400">Value: <span id="wContentVal">0.60</span></div>
          </label>

          <label class="text-sm">Friends' playtime weight
            <input id="wPlay" type="range" min="0" max="1" step="0.05" value="0.30" class="mt-3 w-full" />
            <div class="text-xs text-zinc-400">Value: <span id="wPlayVal">0.30</span></div>
          </label>

          <label class="text-sm md:col-span-3">Friends' similarity weight
            <input id="wSocial" type="range" min="0" max="1" step="0.05" value="0.10" class="mt-3 w-full" />
            <div class="text-xs text-zinc-400">Value: <span id="wSocialVal">0.10</span> · Tip: if results look flat, adjust the weights.</div>
          </label>
        </div>

        <div class="flex items-center gap-3">
          <button id="recBtn" type="submit" class="btn rounded-xl px-4 py-2 disabled:opacity-50">Get recommendations</button>
          <button id="recReset" type="button" class="rounded-xl px-4 py-2 outline">Reset</button>
          <span id="recStatus" class="text-xs text-zinc-400" aria-live="polite"></span>
        </div>

        <!-- Ranked list -->
        <ol id="recList" class="mt-3 text-sm list-decimal pl-6 space-y-1"></ol>
        <p id="recHint" class="hidden mt-2 text-xs text-amber-300">
          All signals look ~0. If your Steam profile or recent games are private—or you haven’t played recently—the model can’t personalize.
          Try increasing <em>Content</em> weight or making playtime visible, then retry.
        </p>
      </form>
    </section>

    <section class="mt-6 card p-6">
      <h2 class="text-lg font-semibold">How it works</h2>
      <ul class="list-disc pl-5 text-sm mt-2 space-y-1 text-zinc-300">
        <li>Catalog of top 20k games with name/description/genres → TF-IDF vectors.</li>
        <li>Aggregates your + friends’ recent playtime via Steam Web API.</li>
        <li>Scores candidates with weighted signals: content similarity, friends’ playtime, friends’ similarity.</li>
      </ul>
    </section>
  </main>

  <footer class="py-10 text-center text-xs text-zinc-500">© <span id="y"></span> Modi Goldstein-Rosenfeld · Steam Recommender</footer>

  <script>
    // === CONFIG ===
    const CONFIG = {
      endpoints: {
        steamRec: 'https://steam-rec-modi-2-gdefgecbdah9hqfx.westus-01.azurewebsites.net/api/recommend'
      },
      requestTimeoutMs: 20000
    };

    const $ = (s)=>document.querySelector(s);
    $('#y').textContent = new Date().getFullYear();

    // Live label updates
    $('#wContent').addEventListener('input', e=> $('#wContentVal').textContent = Number(e.target.value).toFixed(2));
    $('#wPlay').addEventListener('input',   e=> $('#wPlayVal').textContent   = Number(e.target.value).toFixed(2));
    $('#wSocial').addEventListener('input', e=> $('#wSocialVal').textContent = Number(e.target.value).toFixed(2));

    try { const last = localStorage.getItem('steamId'); if (last) $('#steamId').value = last; } catch {}

    const setStatus=(el,msg,ok=false)=>{ el.textContent=msg; el.className=`text-xs ${ok? 'text-green-400':'text-zinc-400'}` };
    const showAlert=(msg)=>{ const a=$('#alert'); a.textContent=msg; a.classList.remove('hidden'); };
    const hideAlert=()=> $('#alert').classList.add('hidden');
    const isSteam64=(s)=>/^7656119\d{10}$/.test(s);
    const fetchWithTimeout=(url,opt={},ms=15000)=>{
      const c=new AbortController(); const t=setTimeout(()=>c.abort(),ms);
      return fetch(url,{...opt,signal:c.signal}).finally(()=>clearTimeout(t));
    };

    document.getElementById('steamForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      hideAlert();
      const btn = $('#recBtn');
      const steamId=($('#steamId').value||'').trim();
      const wContent=parseFloat($('#wContent').value||'0.6');
      const wPlay=parseFloat($('#wPlay').value||'0.3');
      const wSocial=parseFloat($('#wSocial').value||'0.1');
      const status=$('#recStatus');
      const list=$('#recList');
      const hint=$('#recHint');
      list.innerHTML=''; hint.classList.add('hidden');

      // Validate ID early
      if (!isSteam64(steamId)){
        showAlert('Invalid SteamID64 (must start with 7656119 and be 17 digits).');
        return;
      }
      if (!CONFIG.endpoints.steamRec){
        showAlert('Backend endpoint not configured.');
        return;
      }

      try { localStorage.setItem('steamId', steamId); } catch {}

      try{
        btn.disabled = true; setStatus(status,'Calling backend…');

        const u=new URL(CONFIG.endpoints.steamRec);
        u.searchParams.set('steam_id', steamId);
        u.searchParams.set('k', 12);
        u.searchParams.set('w_content', wContent);
        u.searchParams.set('w_playtime', wPlay);
        u.searchParams.set('w_social', wSocial);

        const res = await fetchWithTimeout(u.toString(), { method:'GET' }, CONFIG.requestTimeoutMs);

        if (!res.ok){
          const txt = await res.text().catch(()=> '');
          // Common Steam privacy/invalid-key surfaces as 400/403 from your API
          throw new Error(`HTTP ${res.status} — ${txt.slice(0,200) || 'request failed'}`);
        }

        let data;
        try { data = await res.json(); }
        catch { throw new Error('Bad response: could not parse JSON.'); }

        if (!Array.isArray(data) || data.length===0){
          setStatus(status,'No recommendations (privacy / not enough recent playtime).');
          return;
        }

        // RANK ONLY — no percent scores
        let zeroSignals = 0;
        data.slice(0,12).forEach((r, i)=>{
          const li=document.createElement('li');
          const title = r.title || 'Untitled';
          // track if backend delivered zero signal; if all are zero, show hint
          const val = (typeof r.score === 'number') ? r.score : 0;
          if (val === 0) zeroSignals++;
          li.textContent = title;
          list.appendChild(li);
        });

        if (zeroSignals === Math.min(12, data.length)) { hint.classList.remove('hidden'); }
        setStatus(status,'Done.',true);

      }catch(e){
        console.error(e);
        // Friendly timeout message
        if (e.name === 'AbortError') showAlert('Request timed out. Please try again (or reduce server load).');
        else showAlert(e.message || 'Request failed.');
        setStatus(status,'');
      }finally{
        btn.disabled=false;
      }
    });

    $('#recReset').addEventListener('click', ()=>{
      hideAlert();
      $('#steamId').value='';
      $('#recList').innerHTML='';
      $('#recStatus').textContent='';
      $('#recHint').classList.add('hidden');
    });
  </script>
</body>
</html>
