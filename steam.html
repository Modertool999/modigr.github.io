<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Video Game Recommender · Modi</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" type="image/png" href="jets-favicon.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ color-scheme:dark; --jets:#125740; --panel:#0b1713; --line:#1a2b24; --ink:#e8f3ed; --ui-font:"IBM Plex Sans","Segoe UI","Helvetica Neue",Arial,sans-serif; }
    *{ box-sizing:border-box; }
    body, button, input, select, textarea{ font-family:var(--ui-font) !important; }
    body{ margin:0; background:var(--panel); color:var(--ink); }
    a{ color:#8fe9b8; } a:hover{text-decoration:underline;}
    .wrap{ max-width:1040px; margin:0 auto; padding:0 16px; }

    header{ position:sticky; top:0; z-index:10; background:rgba(14,71,54,.95); border-bottom:2px solid #0a2e23; box-shadow:0 2px 0 #062119; }
    .row{ display:flex; align-items:center; justify-content:space-between; padding:10px 0; }
    nav a{ margin-left:16px; color:#c9f3e0; } nav a.active{ color:#fff; text-shadow:0 1px 0 #083326; }

    .brand{ font-weight:800; letter-spacing:.3px; position:relative; display:inline-block; color:#fff; text-shadow:0 1px 0 #083326; }
    .brand::after{ content:""; position:absolute; left:0; bottom:-3px; height:3px; width:100%; background:#8fe9b8; transform:scaleX(0); transform-origin:left; transition:transform .25s ease; }
    .brand:hover::after{ transform:scaleX(1); } .brand:hover{ transform: translateY(-1px) rotate(-.2deg); transition: transform .2s ease; }

    .card{ background:#0f201a; border:1px solid var(--line); border-radius:14px; padding:18px; box-shadow:inset 0 1px 0 rgba(255,255,255,.03), 0 2px 0 #07140f; }
    .btn{ display:inline-block; padding:10px 14px; background:#1bb774; color:#fff; border-radius:10px; border:1px solid #0a5a3a; box-shadow:inset 0 1px 0 #54e0a4, 0 2px 0 #073e2a; }
    .btn:hover{ filter:brightness(1.08); }
    .btn-outline{ display:inline-block; padding:10px 14px; border:1px solid var(--line); border-radius:10px; color:var(--ink); background:#0d1b16; }
    .btn-outline:hover{ background:#0f201a; }

    input[type="text"]{ width:100%; padding:10px; border-radius:10px; border:1px solid var(--line); background:#0f1d18; color:#fff; }
    input[type="range"]{ width:100%; }

    .alert{ display:none; border:1px solid #742a2a; background:#2a1616; color:#ffd8d8; padding:10px 12px; border-radius:10px; }
    .alert.show{ display:block; }
    .hint{ display:none; color:#f6e0a5; font-size:12px; margin-top:6px; }
    .hint.show{ display:block; }
    ol{ margin-top:10px; padding-left:22px; }
    .uptime-note{ margin-top:12px; padding:12px; border-radius:10px; border:1px dashed #1d5c45; background:#0f1f18; font-size:13px; color:#cfeee2; line-height:1.45; }
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <a class="brand" href="index.html">Modi Goldstein-Rosenfeld</a>
      <nav>
        <a href="index.html">Home</a>
        <a class="active" href="steam.html">Video Game Recommender</a>
        <a href="spy.html">SPY</a>
        <a href="https://github.com/Modertool999/game-recommender" target="_blank" rel="noopener">Repo ↗</a>
      </nav>
    </div>
  </header>

  <main class="wrap" style="padding-top:20px;">
    <section class="card">
      <h1 style="margin:0 0 6px 0; font-size:28px;">Video Game Recommender</h1>
      <p style="margin:0;">Paste your <b>SteamID64</b>, set three weights, and get a <b>ranked</b> list of games.
        <span style="display:block; font-size:13px; color:#a9d7c5; margin-top:4px;">
          This app uses <a href = "https://store.steampowered.com/" target="_blank">Steam</a> (a popular PC gaming platform) data to personalize video game recommendations.
        </span>
      </p>
      <div class="uptime-note">
        Note: the Azure backend sleeps most of the time so it doesn’t burn through credits. Early requests can fail while it cold-starts, just refresh/resubmit a couple of times (2–3 tries tops) and it will come online.
      </div>
    </section>

    <section class="card" style="margin-top:18px;">
      <div id="alert" class="alert"></div>

      <form id="steamForm" novalidate>
        <div class="grid" style="display:grid; gap:16px; grid-template-columns: 1fr 1fr 1fr;">
          <label>
            <div style="font-size:14px;">SteamID64</div>
            <input id="steamId" type="text" inputmode="numeric" pattern="^7656119\\d{10}$" placeholder="7656119XXXXXXXXXX" required />
            <div style="font-size:12px;color:#a9d7c5;margin-top:6px;">
              Find it at <a href="https://steamid.io/lookup" target="_blank" rel="noopener">steamid.io/lookup</a> and copy SteamID64, ex 76561197990267310
            </div>
          </label>

          <label>
            <div style="font-size:14px;">Weight: Your recent playtime</div>
            <input id="wContent" type="range" min="0" max="1" step="0.05" value="0.60" />
            <div style="font-size:12px;color:#a9d7c5;">Value: <span id="wContentVal">0.60</span></div>
          </label>

          <label>
            <div style="font-size:14px;">Weight: Friends’ playtime</div>
            <input id="wPlay" type="range" min="0" max="1" step="0.05" value="0.30" />
            <div style="font-size:12px;color:#a9d7c5;">Value: <span id="wPlayVal">0.30</span></div>
          </label>

          <label style="grid-column:1 / -1;">
            <div style="font-size:14px;">Weight: Similarity to friends’ plays</div>
            <input id="wSocial" type="range" min="0" max="1" step="0.05" value="0.10" />
            <div style="font-size:12px;color:#a9d7c5;">Value: <span id="wSocialVal">0.10</span> · If results look flat, tweak weights.</div>
          </label>
        </div>

        <div style="display:flex; gap:12px; align-items:center; margin-top:12px;">
          <button id="recBtn" type="submit" class="btn">Get recommendations</button>
          <button id="recReset" type="button" class="btn-outline">Reset</button>
          <span id="recStatus" style="font-size:12px; color:#a9d7c5;" aria-live="polite"></span>
        </div>

        <ol id="recList"></ol>
        <div id="recHint" class="hint">Signals look ~0. If your profile or recent games are private (or you haven’t played recently), personalization won’t work. Raise the <em>Your recent playtime</em> weight or make playtime visible, then retry.</div>
      </form>
    </section>

    <section class="card" style="margin-top:18px;">
      <h2 style="margin:0 0 6px 0; font-size:22px;">How it works</h2>
      <ul style="margin:0;">
        <li>TF-IDF over top games’ name/description/genres.</li>
        <li>Pulls your + friends’ recent playtime via Steam Web API.</li>
        <li>Blends signals from: your recent playtime, friends’ playtime, similarity to friends’ plays.</li>
      </ul>
    </section>
  </main>

  <script>
    const PROD_ENDPOINTS = [
      'https://steam-rec-modi-2-gdefgecbdah9hqfx.westus-01.azurewebsites.net/api/recommend'
    ];
    const LOCAL_ENDPOINTS = [
      'http://127.0.0.1:5000/api/recommend',
      'http://localhost:5000/api/recommend'
    ];
    const host = window.location.hostname || '';
    const proto = window.location.protocol;
    const qs = new URLSearchParams(window.location.search);
    const override = qs.get('steamBackend');
    const overrideMode = override === 'local'
      ? 'local'
      : (override === 'prod' ? 'prod' : null);

    const candidateEndpoints = (() => {
      if (override && override.startsWith('http')) return [override];
      if (overrideMode === 'local') return [...LOCAL_ENDPOINTS];
      if (overrideMode === 'prod') return [...PROD_ENDPOINTS];
      if (proto === 'file:' || ['localhost', '127.0.0.1', '0.0.0.0', '[::1]'].includes(host)) {
        return [...LOCAL_ENDPOINTS];
      }
      return [...PROD_ENDPOINTS];
    })();
    const isLocalEndpoint = (endpoint)=>/^https?:\/\/(127\.0\.0\.1|localhost|0\.0\.0\.0|\[::1\])/.test(endpoint || '');
    const primaryEndpoint = candidateEndpoints[0] || PROD_ENDPOINTS[0];
    const useLocalDefault = isLocalEndpoint(primaryEndpoint);

    const CONFIG = {
      endpoints: candidateEndpoints,
      requestTimeoutMs: useLocalDefault ? 15000 : 30000,
      lastEndpoint: null
    };
    const $=(s)=>document.querySelector(s);
    const yearEl=$('#y'); if(yearEl) yearEl.textContent=new Date().getFullYear();
    const hintEl=$('#recHint');
    const hintDefaultText=hintEl?hintEl.textContent:"";

    $('#wContent').addEventListener('input', e=> $('#wContentVal').textContent=Number(e.target.value).toFixed(2));
    $('#wPlay').addEventListener('input',   e=> $('#wPlayVal').textContent  =Number(e.target.value).toFixed(2));
    $('#wSocial').addEventListener('input', e=> $('#wSocialVal').textContent=Number(e.target.value).toFixed(2));
    try{ const last=localStorage.getItem('steamId'); if(last) $('#steamId').value=last; }catch{}

    const setStatus=(msg,ok=false)=>{ const el=$('#recStatus'); el.textContent=msg||""; el.style.color= ok ? '#9ef5b2' : '#a9d7c5'; };
    const showAlert=(m)=>{ const a=$('#alert'); a.textContent=m; a.classList.add('show'); };
    const hideAlert=()=> $('#alert').classList.remove('show');
    const isSteam64=(s)=>/^7656119\d{10}$/.test(s);
    const fetchWithTimeout=(url,opt={},ms=15000)=>{ const c=new AbortController(); const t=setTimeout(()=>c.abort(),ms); return fetch(url,{...opt,signal:c.signal}).finally(()=>clearTimeout(t)); };
    const maskSecrets=(str='')=>str
      .replace(/key=([^&"\s]+)/gi,'key=***')
      .replace(/apikey=([^&"\s]+)/gi,'apikey=***')
      .replace(/api_key=([^&"\s]+)/gi,'api_key=***');

    document.getElementById('steamForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); hideAlert();
      const btn=$('#recBtn'); const list=$('#recList'); const hint=$('#recHint');
      list.innerHTML='';
      if(hint){
        hint.classList.remove('show');
        hint.textContent=hintDefaultText;
      }
      setStatus('');

      const steamId=($('#steamId').value||'').trim();
      if(!isSteam64(steamId)){ showAlert('Invalid SteamID64 (starts with 7656119 and has 17 digits).'); return; }
      if(!CONFIG.endpoints || CONFIG.endpoints.length===0){ showAlert('Backend endpoint not configured.'); return; }

      const wContent=parseFloat($('#wContent').value||'0.6');
      const wPlay   =parseFloat($('#wPlay').value||'0.3');
      const wSocial =parseFloat($('#wSocial').value||'0.1');
      try{ localStorage.setItem('steamId', steamId); }catch{}

      try{
        btn.disabled=true; setStatus('Calling backend…');

        const endpoints=[...CONFIG.endpoints];
        let res=null;
        let lastErr=null;
        let usedEndpoint=null;
        for(let i=0;i<endpoints.length;i++){
          const endpoint=endpoints[i];
          usedEndpoint=endpoint;
          const url=new URL(endpoint);
          url.searchParams.set('steam_id', steamId);
          url.searchParams.set('k', 12);
          url.searchParams.set('w_content', wContent);
          url.searchParams.set('w_playtime', wPlay);
          url.searchParams.set('w_social', wSocial);
          try{
            const attempt=await fetchWithTimeout(url.toString(), {method:'GET'}, CONFIG.requestTimeoutMs);
            if(!attempt.ok){
              const txt=await attempt.text().catch(()=> '');
              let detail='';
              if(txt){
                try{
                  const parsed=JSON.parse(txt);
                  if(parsed && typeof parsed.error==='string') detail=parsed.error;
                  else detail=txt;
                }catch{ detail=txt; }
              }
              const masked=maskSecrets(detail).slice(0,200);
              const friendly= attempt.status===401 || /unauthorized/i.test(masked)
                ? 'Steam rejected the request, most likely because that profile does not allow friend-list access.'
                : (masked || 'request failed');
              lastErr=new Error(`HTTP ${attempt.status} - ${friendly}`);
              lastErr.endpoint=endpoint;
              continue;
            }
            res=attempt;
            CONFIG.lastEndpoint=endpoint;
            if(i>0){
              const dedup=[endpoint,...endpoints.filter((value,idx)=>idx!==i && value!==endpoint)];
              CONFIG.endpoints=dedup;
            }
            break;
          }catch(fetchErr){
            lastErr=fetchErr;
            lastErr.endpoint=endpoint;
          }
        }
        if(!res){
          if(lastErr) throw lastErr;
          const err=new Error('No backend endpoint reachable.');
          err.endpoint=usedEndpoint || endpoints[0];
          throw err;
        }

        let payload; try{ payload=await res.json(); }catch{ throw new Error('Bad response: could not parse JSON.'); }
        const results = Array.isArray(payload)
          ? payload
          : (payload && typeof payload === 'object' && Array.isArray(payload.results) ? payload.results : []);
        const meta = (!Array.isArray(payload) && payload && typeof payload === 'object') ? (payload.meta || null) : null;
        if(!Array.isArray(results) || results.length===0){
          const emptyMsg = meta && meta.features && meta.features.friends_requested
            ? 'No recommendations. Steam returned little to no recent activity for this profile.'
            : 'No recommendations (privacy / not enough recent playtime).';
          setStatus(emptyMsg);
          if(hint && meta){
            const hintMsgs=[];
            const feats=meta.features||{};
            if(feats.friends_requested && feats.friends_accessible===0){
              hintMsgs.push('Friends data appears private, so social weights cannot contribute yet.');
            }
            if(feats.used_library_fallback){
              hintMsgs.push('Falling back to lifetime play hours because no recent playtime was available.');
            }
            if(hintMsgs.length){
              hint.textContent=hintMsgs.join(' ');
              hint.classList.add('show');
            }
          }
          return;
        }

        const totalCount=results.length;
        const showCount=Math.min(12,totalCount);
        let zeroSignals=0;
        results.slice(0,showCount).forEach((r,idx)=>{
          const li=document.createElement('li');
          let val=typeof r.score==='number'? r.score:parseFloat(r.score);
          if(!Number.isFinite(val)) val=0;
          if(val===0) zeroSignals++;
          const title=r.title || 'Untitled';
          li.textContent=title;
          li.dataset.rank=(idx+1).toString();
          li.dataset.score=val.toFixed(3);
          list.appendChild(li);
        });
        const hintMsgs=[];
        if(meta){
          const signals=meta.signals||{};
          const friendsAvailable=Boolean((signals.friends_play && signals.friends_play.available) || (signals.friends_sim && signals.friends_sim.available));
          if(!friendsAvailable && (wPlay>0.0001 || wSocial>0.0001)){
            hintMsgs.push('Friends data is private or unavailable, so the friend weights cannot influence results right now.');
          }
          const feats=meta.features||{};
          if(feats.used_library_fallback){
            hintMsgs.push('No recent playtime detected');
          }
        }
        if (zeroSignals === showCount) hintMsgs.push(hintDefaultText);
        if(hint && hintMsgs.length){
          hint.textContent=hintMsgs.join(' ');
          hint.classList.add('show');
        }

        let statusMsg=`Showing ${showCount} of ${totalCount} recommendations.`;
        if(meta && meta.signals){
          const fmt=(value)=>Number.parseFloat(value||0).toFixed(2);
          const parts=[];
          const labels={user:'You', friends_play:"Friends' playtime", friends_sim:'Friends similarity'};
          Object.entries(labels).forEach(([key,label])=>{
            const info=meta.signals[key];
            if(!info) return;
            const inactive=!info.available;
            const applied=fmt(info.applied_weight);
            parts.push(`${label} ${applied}${inactive ? ' (inactive)' : ''}`);
          });
          if(parts.length) statusMsg += ` Weights: ${parts.join(' · ')}`;
        }
        setStatus(statusMsg, true);

      }catch(e){
        const endpointHint = (e && e.endpoint) || CONFIG.lastEndpoint || CONFIG.endpoints[0] || '';
        const localErr = isLocalEndpoint(endpointHint);
        if(e.name==='AbortError') showAlert('Request timed out. This Steam ID’s data looks especially large, so I added a limit to keep Azure computation manageable.');
        else if(e && (e.message === 'Failed to fetch' || e instanceof TypeError)){
          const tip = localErr
            ? 'Could not reach the local backend. Is the Flask server running on port 5000?'
            : `Could not reach ${endpointHint || 'the hosted backend'}. Please refresh and try again in a bit.`;
          showAlert(`${tip} (Network error)`);
        }else showAlert(e.message || 'Request failed.');
        setStatus('');
      }finally{ btn.disabled=false; }
    });

    document.getElementById('recReset').addEventListener('click', ()=>{
      hideAlert(); $('#steamId').value=''; $('#recList').innerHTML=''; $('#recHint').classList.remove('show'); setStatus('');
    });
  </script>
</body>
</html>
