<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SPY Forecaster · Modi</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" type="image/png" href="jets-favicon.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" defer></script>
  <!-- Inter: clean sans-serif -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ color-scheme:dark; --panel:#0b1713; --line:#1a2b24; --ink:#e8f3ed; --ui-font:"Inter","Segoe UI","Helvetica Neue",Arial,sans-serif; }
    *{ box-sizing:border-box; }
    body, button, input, select, textarea{ font-family:var(--ui-font) !important; }
    body{ margin:0; background:var(--panel); color:var(--ink); }
    a{ color:#8fe9b8; } a:hover{text-decoration:underline;}
    .wrap{ max-width:1040px; margin:0 auto; padding:0 16px; }

    header{ position:sticky; top:0; z-index:10; background:linear-gradient(180deg,rgba(18,87,64,.95),rgba(14,71,54,.92)); border-bottom:2px solid #0a2e23; box-shadow:0 2px 0 #062119; }
    .row{ display:flex; align-items:center; justify-content:space-between; padding:10px 0; }
    nav a{ margin-left:16px; color:#c9f3e0; } nav a.active{ color:#fff; text-shadow:0 1px 0 #083326; }

    .brand{ font-weight:800; letter-spacing:.3px; position:relative; display:inline-block; color:#fff; text-shadow:0 1px 0 #083326; }
    .brand::after{ content:""; position:absolute; left:0; bottom:-3px; height:3px; width:100%; background:linear-gradient(90deg,#87f6bf,#e4ffe4,#87f6bf); transform:scaleX(0); transform-origin:left; transition:transform .25s ease; }
    .brand:hover::after{ transform:scaleX(1); } .brand:hover{ transform: translateY(-1px) rotate(-.2deg); transition: transform .2s ease; }

    .card{ background:linear-gradient(180deg,#0f201a,#0b1713); border:1px solid var(--line); border-radius:14px; padding:18px; box-shadow:inset 0 1px 0 rgba(255,255,255,.03), 0 2px 0 #07140f; }
    .btn{ display:inline-block; padding:10px 14px; background:linear-gradient(180deg,#1bb774,#0e7c51); color:#fff; border-radius:10px; border:1px solid #0a5a3a; box-shadow:inset 0 1px 0 #54e0a4, 0 2px 0 #073e2a; }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }
    .btn-outline{ display:inline-block; padding:10px 14px; border:1px solid var(--line); border-radius:10px; color:var(--ink); background:#0d1b16; }
    .btn-outline:hover{ background:#0f201a; }

    input[type="text"], input[type="number"]{ width:100%; padding:10px; border-radius:10px; border:1px solid var(--line); background:#0f1d18; color:#fff; }

    .grid{ display:grid; gap:16px; }
    @media(min-width:900px){ .grid-4{ grid-template-columns:1fr 1fr 1fr auto; } .grid-4>*{ min-width:0; } }

    .date-field-loading{ display:none; font-size:12px; color:#a9d7c5; margin-top:6px; }
    .date-field-ready{ display:flex; flex-direction:column; gap:6px; }
    body[data-window-ready="false"] .date-field-ready{ display:none; }
    body[data-window-ready="false"] .date-field-loading{ display:block; }

    .alert{ display:none; border:1px solid #742a2a; background:#2a1616; color:#ffd8d8; padding:10px 12px; border-radius:10px; margin-bottom:10px; }
    .alert.show{ display:block; }
    .uptime-note{ margin-top:12px; padding:12px; border-radius:10px; border:1px dashed #1d5c45; background:#0f1f18; font-size:13px; color:#cfeee2; line-height:1.45; }
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <a class="brand" href="index.html">Modi Goldstein-Rosenfeld</a>
      <nav>
        <a href="index.html">Home</a>
        <a href="steam.html">Video Game Recommender</a>
        <a class="active" href="spy.html">SPY</a>
        <a href="https://github.com/Modertool999/spy-forecast" target="_blank" rel="noopener">Repo ↗</a>
      </nav>
    </div>
  </header>

  <main class="wrap" style="padding-top:20px;">
    <section class="card">
      <h1 style="margin:0 0 6px 0; font-size:28px;">S&amp;P 500 Next-Day Forecaster</h1>
      <p style="margin:0;">
        Backtest a long-or-cash strategy from engineered price features and compare against a simple buy-and-hold strategy.
      </p>
      <div class="uptime-note">
        Note: the Azure backend sleeps most of the time so it doesn’t burn through credits. Early requests can fail while it cold-starts, just refresh/resubmit a couple of times (2–3 tries tops) and it will come online.
      </div>
    </section>

    <section class="card" style="margin-top:18px;">
      <div id="alert" class="alert"></div>

      <form id="spyForm" novalidate>
        <div class="grid grid-4">
          <label>
            <div style="font-size:14px;">Threshold</div>
            <input id="thr" type="number" min="0" max="1" step="0.01" value="0.55" />
          </label>
          <label class="date-field">
            <div style="font-size:14px;">Start (YYYY-MM-DD)</div>
            <div class="date-field-loading">Loading cached window…</div>
            <div class="date-field-ready">
              <!-- IMPORTANT: single backslashes in pattern, default value updated via JS -->
              <input id="startDate" type="text" pattern="^\d{4}-\d{2}-\d{2}$" value="2022-01-03" required />
              <div style="font-size:12px;color:#a9d7c5;">Earliest allowed: <span id="startDefault">2022-01-03</span></div>
            </div>
          </label>
          <label class="date-field">
            <div style="font-size:14px;">End (YYYY-MM-DD)</div>
            <div class="date-field-loading">Loading cached window…</div>
            <div class="date-field-ready">
              <!-- Prefilled default value -->
              <input id="endDate" type="text" pattern="^\d{4}-\d{2}-\d{2}$" value="2025-11-07" required />
              <div style="font-size:12px;color:#a9d7c5;">Latest allowed: <span id="endDefault">2025-11-07</span></div>
            </div>
          </label>
          <div style="display:flex; align-items:flex-end; gap:12px;">
            <!-- type=button so clicks always fire regardless of form validity UI -->
            <button id="runBacktest" type="button" class="btn">Run backtest</button>
            <button id="resetBacktest" type="button" class="btn-outline">Reset</button>
          </div>
        </div>
      </form>

      <div style="margin-top:14px;">
        <canvas id="equityChart" height="180"></canvas>
      </div>
      <div class="grid" style="grid-template-columns: repeat(4, 1fr); gap:12px; margin-top:12px;">
        <div class="btn-outline" style="padding:10px; border-radius:12px;"><div style="font-size:12px;color:#a9d7c5;">Total return</div><div id="statTR" style="font-weight:700; font-size:18px;">—</div></div>
        <div class="btn-outline" style="padding:10px; border-radius:12px;"><div style="font-size:12px;color:#a9d7c5;">CAGR</div><div id="statCAGR" style="font-weight:700; font-size:18px;">—</div></div>
        <div class="btn-outline" style="padding:10px; border-radius:12px;"><div style="font-size:12px;color:#a9d7c5;">Sharpe</div><div id="statSharpe" style="font-weight:700; font-size:18px;">—</div></div>
        <div class="btn-outline" style="padding:10px; border-radius:12px;"><div style="font-size:12px;color:#a9d7c5;">Max drawdown</div><div id="statMDD" style="font-weight:700; font-size:18px;">—</div></div>
      </div>
    </section>

    <section class="card" style="margin-top:18px;">
      <h2 style="margin:0 0 6px 0; font-size:22px;">How it works</h2>
      <ul style="margin:0;">
        <li>Daily SPY from Yahoo Finance since 2005.</li>
        <li>Lagged features (returns, RSI, overnight gap).</li>
        <li>Train/valid/test, long-or-cash strategy (2 bps trading costs).</li>
      </ul>
    </section>
  </main>

  <script>
    const API_BASE='https://spy-forecast-modi-2-gka4h2cng6dhcvcf.westus-01.azurewebsites.net';
    const DATE_KEYS=['equity_dates','baseline_dates','dates','price_dates','labels'];
    const HARD_LIMITS=Object.freeze({ start:'2022-01-03', end:'2025-11-07' });
    const CONFIG = {
      endpoints:{
        spyForecast:`${API_BASE}/api/spy-backtest`,
        spyWindow:`${API_BASE}/api/spy-window`
      },
      requestTimeoutMs:20000,
      window:{ start:'2022-01-03', end:'2025-11-07' }
    };
    const $=(s)=>document.querySelector(s);
    const els={
      year:document.getElementById('y'),
      alert:document.getElementById('alert'),
      windowStart:document.getElementById('windowStart'),
      windowEnd:document.getElementById('windowEnd'),
      clampStart:document.getElementById('clampStart'),
      clampEnd:document.getElementById('clampEnd'),
      startDefault:document.getElementById('startDefault'),
      endDefault:document.getElementById('endDefault'),
      startInput:document.getElementById('startDate'),
      endInput:document.getElementById('endDate'),
      thresholdInput:document.getElementById('thr'),
      btStatus:document.getElementById('btStatus'),
      actualRange:document.getElementById('actualRange'),
      actualRangeStart:document.getElementById('actualRangeStart'),
      actualRangeEnd:document.getElementById('actualRangeEnd'),
      runBtn:document.getElementById('runBacktest'),
      resetBtn:document.getElementById('resetBacktest'),
      form:document.getElementById('spyForm')
    };
    if(els.runBtn) els.runBtn.disabled=true;
    const statsEls={
      tr:document.getElementById('statTR'),
      cagr:document.getElementById('statCAGR'),
      sharpe:document.getElementById('statSharpe'),
      mdd:document.getElementById('statMDD')
    };
    let chart;
    const clampWindowToHardLimits=()=>{
      if(CONFIG.window.start < HARD_LIMITS.start) CONFIG.window.start = HARD_LIMITS.start;
      if(CONFIG.window.end > HARD_LIMITS.end) CONFIG.window.end = HARD_LIMITS.end;
    };
    clampWindowToHardLimits();

    const setWindowReady=(ready)=>{
      const body=document.body;
      if(!body) return;
      body.dataset.windowReady=ready?'true':'false';
    };
    setWindowReady(false);
    if(els.year) els.year.textContent=new Date().getFullYear();

    const setStatus=(m,ok=false)=>{ if(!els.btStatus) return; els.btStatus.textContent=m||""; els.btStatus.style.color= ok ? '#9ef5b2' : '#a9d7c5'; };
    const showAlert=(m='')=>{ if(!els.alert) return; els.alert.textContent=m; els.alert.classList.add('show'); };
    const hideAlert=()=>{ if(!els.alert) return; els.alert.textContent=''; els.alert.classList.remove('show'); };
    const clearStats=()=>{ Object.values(statsEls).forEach(el=>{ if(el) el.textContent='—'; }); };
    const fetchWithTimeout=(url,opt={},ms=15000)=>{ const controller=new AbortController(); const timer=setTimeout(()=>controller.abort(),ms); return fetch(url,{...opt,signal:controller.signal}).finally(()=>clearTimeout(timer)); };
    const isISO=(s)=>/^\d{4}-\d{2}-\d{2}$/.test(s);
    const withinWindow=(s)=>{
      if(!s) return false;
      const d=new Date(s);
      if(Number.isNaN(d.valueOf())) return false;
      return d>=new Date(CONFIG.window.start) && d<=new Date(CONFIG.window.end);
    };
    const setActualWindow=(start,end)=>{
      if(!els.actualRange) return;
      const ok=isISO(start)&&isISO(end);
      if(ok){
        if(els.actualRangeStart) els.actualRangeStart.textContent=start;
        if(els.actualRangeEnd) els.actualRangeEnd.textContent=end;
        els.actualRange.style.display='block';
      }else{
        els.actualRange.style.display='none';
      }
    };

    function updateWindowUI(){
      if(els.windowStart) els.windowStart.textContent=CONFIG.window.start;
      if(els.windowEnd) els.windowEnd.textContent=CONFIG.window.end;
      if(els.clampStart) els.clampStart.textContent=CONFIG.window.start;
      if(els.clampEnd) els.clampEnd.textContent=CONFIG.window.end;
      if(els.startDefault) els.startDefault.textContent=CONFIG.window.start;
      if(els.endDefault) els.endDefault.textContent=CONFIG.window.end;
      if(els.startInput && els.startInput.dataset.userSet!=='true'){ els.startInput.value=CONFIG.window.start; }
      if(els.endInput && els.endInput.dataset.userSet!=='true'){ els.endInput.value=CONFIG.window.end; }
    }

    const normalizeDateString=(str)=>{
      if(typeof str!=='string') return null;
      const trimmed=str.trim();
      if(!trimmed) return null;
      if(isISO(trimmed)) return trimmed;
      const d=new Date(trimmed);
      return Number.isNaN(d.valueOf()) ? null : d.toISOString().slice(0,10);
    };
    const clampIsoDate=(iso)=>{
      if(!isISO(iso)) return iso;
      if(iso<CONFIG.window.start) return CONFIG.window.start;
      if(iso>CONFIG.window.end) return CONFIG.window.end;
      return iso;
    };
    const sanitizeDateInput=(inputEl)=>{
      if(!inputEl) return { iso:null };
      const raw=(inputEl.value||'').trim();
      if(!raw) return { iso:null };
      if(!isISO(raw)) return { iso:null };
      const clamped=clampIsoDate(raw);
      if(inputEl.value!==clamped) inputEl.value=clamped;
      return { iso:clamped };
    };

    function buildDateLabels(rawDates, start, len){
      if(Array.isArray(rawDates)){
        const cleaned=rawDates.map(normalizeDateString).filter(Boolean);
        if(cleaned.length>=len) return cleaned.slice(0,len);
      }
      if(isISO(start)){
        const base=new Date(start);
        if(!Number.isNaN(base.valueOf())){
          return Array.from({length:len},(_,idx)=>{
            const d=new Date(base);
            d.setDate(base.getDate()+idx);
            return d.toISOString().slice(0,10);
          });
        }
      }
      return Array.from({length:len},(_,idx)=>`Day ${idx+1}`);
    }

    function extractErrorDetail(status, bodyText){
      const fallback=`Request failed (HTTP ${status}).`;
      if(!bodyText) return fallback;
      const trimmed=bodyText.trim();
      if(!trimmed) return fallback;
      try{
        const parsed=JSON.parse(trimmed);
        if(typeof parsed.detail==='string') return parsed.detail;
        if(Array.isArray(parsed.detail)){
          return parsed.detail.map(entry=>{
            if(typeof entry==='string') return entry;
            if(entry && typeof entry.msg==='string') return entry.msg;
            return '';
          }).filter(Boolean).join(' ');
        }
      }catch(_err){}
      return trimmed;
    }

    async function hydrateWindow(){
      try{
        const res=await fetchWithTimeout(CONFIG.endpoints.spyWindow,{},10000);
        const payload=await res.text();
        if(!res.ok) throw new Error(extractErrorDetail(res.status,payload));
        const data=JSON.parse(payload);
        if(!data.start || !data.end) throw new Error('Window metadata missing start/end fields.');
        CONFIG.window.start=data.start;
        CONFIG.window.end=data.end;
        clampWindowToHardLimits();
        updateWindowUI();
      }catch(err){
        console.warn('Window metadata fetch failed', err);
        updateWindowUI();
      }finally{
        setWindowReady(true);
        validateForm();
      }
    }

    function looksRateLimited(status, txt){
      if(status===429 || status===503 || status===502) return true;
      if(typeof txt==='string' && /rate limit|too many requests|temporar/i.test(txt)) return true;
      return false;
    }

    function validateForm(){
      hideAlert();
      if(document.body && document.body.dataset.windowReady!=='true'){
        if(els.runBtn) els.runBtn.disabled=true;
        return false;
      }
      const thr=parseFloat((els.thresholdInput && els.thresholdInput.value) || '0.55');
      const startInfo=sanitizeDateInput(els.startInput);
      const endInfo=sanitizeDateInput(els.endInput);
      const start=startInfo.iso;
      const end=endInfo.iso;
      let ok=true, msg=[];
      const windowMsg=`${CONFIG.window.start} to ${CONFIG.window.end}`;

      if(!(thr>=0 && thr<=1)){ ok=false; msg.push('Threshold must be 0–1.'); }
      if(!start || !end){ ok=false; msg.push('Start/End must be YYYY-MM-DD.'); }
      if(start && end && new Date(start) > new Date(end)){ ok=false; msg.push('Start must be on or before End.'); }
      if(start && !withinWindow(start)){ ok=false; msg.push(`Start must be within ${windowMsg}.`); }
      if(end && !withinWindow(end)){ ok=false; msg.push(`End must be within ${windowMsg}.`); }

      if(els.runBtn) els.runBtn.disabled=!ok;
      if(!ok && msg.length) showAlert(msg.join(' '));
      return ok;
    }

    function resetForm(){
      if(!els.startInput || !els.endInput || !els.thresholdInput) return;
      els.thresholdInput.value='0.55';
      els.startInput.dataset.userSet='';
      els.endInput.dataset.userSet='';
      updateWindowUI();
      clearStats();
      hideAlert();
      setStatus('');
      setActualWindow();
      if(chart){
        chart.data.labels=[];
        chart.data.datasets.forEach(ds=>{ ds.data=[]; });
        chart.update();
      }
      validateForm();
    }

    function ensureChart(){
      if(chart) return chart;
      const canvas=document.getElementById('equityChart'); if(!canvas){ console.error('Canvas missing'); return null; }
      const ctx=canvas.getContext('2d');
      const stratGrad=ctx.createLinearGradient(0,0,0,200); stratGrad.addColorStop(0,'rgba(27,183,116,0.28)'); stratGrad.addColorStop(1,'rgba(27,183,116,0.00)');
      const baselineGrad=ctx.createLinearGradient(0,0,0,200); baselineGrad.addColorStop(0,'rgba(242,201,76,0.20)'); baselineGrad.addColorStop(1,'rgba(242,201,76,0.00)');
      chart=new Chart(ctx,{ type:'line',
        data:{ labels:[], datasets:[
          { label:'Strategy', data:[], borderColor:'#1bb774', backgroundColor:stratGrad, fill:true, borderWidth:2, pointRadius:0, tension:0.18 },
          { label:'Buy & Hold', data:[], borderColor:'#f2c94c', backgroundColor:baselineGrad, fill:false, borderDash:[6,4], borderWidth:2, pointRadius:0, tension:0.18 }
        ] },
        options:{ responsive:true, animation:{duration:220}, interaction:{mode:'index', intersect:false},
          scales:{
            y:{
              beginAtZero:false,
              grid:{ color:'rgba(255,255,255,.08)' },
              ticks:{ color:'#c9f3e0' },
              title:{ display:true, text:'Equity multiple (×)', color:'#a9d7c5', font:{ size:12 } }
            },
            x:{
              display:true,
              grid:{ color:'rgba(255,255,255,.05)' },
              ticks:{
                color:'#c9f3e0',
                autoSkip:true,
                maxTicksLimit:6,
                maxRotation:0,
                callback(value){ return typeof value==='string'? value : this.getLabelForValue(value); }
              },
              title:{ display:true, text:'Date', color:'#a9d7c5', font:{ size:12 } }
            }
          },
          plugins:{ legend:{ display:true, labels:{ color:'#c9f3e0' } }, tooltip:{ callbacks:{ label:(c)=>{
            const label=(c.dataset && c.dataset.label) ? c.dataset.label : 'Value';
            const val=(c.parsed && typeof c.parsed.y==='number') ? c.parsed.y : 0;
            return `${label}: \u00D7 ${val.toFixed(3)}`;
          } } } }
      }});
      return chart;
    }

    async function runBacktest(){
      if(!validateForm()) return;
      hideAlert();
      const btn=els.runBtn;
      const ch=ensureChart();
      if(!btn || !ch) return;
      const thr=parseFloat(els.thresholdInput.value||'0.55');
      const start=els.startInput.value.trim();
      const end=els.endInput.value.trim();

      try{
        btn.disabled=true; setStatus('Running backtest…');
        const res=await fetchWithTimeout(CONFIG.endpoints.spyForecast,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ threshold:thr, start, end })
        }, CONFIG.requestTimeoutMs);

        const txt=await res.text();
        if(!res.ok){
          if(looksRateLimited(res.status, txt)){
            showAlert('Backtest temporarily unavailable or busy. Please try again shortly.');
          }else{
            showAlert(extractErrorDetail(res.status, txt));
          }
          setStatus('');
          return;
        }
        let data;
        try{
          data=JSON.parse(txt);
        }catch(parseErr){
          throw new Error('Unexpected response from the API.');
        }
        setActualWindow(data.start, data.end);
        const eq=Array.isArray(data.equity)? data.equity:[];
        const baseline=Array.isArray(data.baseline_equity)? data.baseline_equity:[];
        const maxLen=Math.max(eq.length, baseline.length);
        if(maxLen===0){
          showAlert('No equity data for that window. Double-check your dates.');
          setStatus('');
          return;
        }

        const rawDates=DATE_KEYS.map(key=>Array.isArray(data[key])? data[key]:null).find(Boolean);
        const labels=buildDateLabels(rawDates, data.start || start, maxLen);
        ch.data.labels=labels;
        if(ch.data.datasets[0]) ch.data.datasets[0].data=eq;
        if(ch.data.datasets[1]) ch.data.datasets[1].data=baseline;
        ch.update();

        const pct=(x)=> (Number(x)||0).toFixed(2);
        if(statsEls.tr) statsEls.tr.textContent   = `${pct(data.total_ret)}%`;
        if(statsEls.cagr) statsEls.cagr.textContent = `${pct(data.cagr)}%`;
        if(statsEls.sharpe) statsEls.sharpe.textContent = data.sharpe!=null? pct(data.sharpe) : '—';
        if(statsEls.mdd) statsEls.mdd.textContent    = data.max_drawdown!=null? `${pct(data.max_drawdown)}%` : '—';
        const statusRange=(data.start && data.end) ? `${data.start} to ${data.end}` : '';
        setStatus(statusRange ? `Done · ${statusRange}` : 'Done.', true);
      }catch(e){
        if(e.name==='AbortError') showAlert('Request timed out. Try again.');
        else showAlert(e.message || 'Request failed.');
        setStatus('');
      }finally{ if(btn) btn.disabled=false; }
    }

    function preservePrefilledInputs(){
      if(els.startInput){
        const val=(els.startInput.value||'').trim();
        if(val && val!==CONFIG.window.start) els.startInput.dataset.userSet='true';
      }
      if(els.endInput){
        const val=(els.endInput.value||'').trim();
        if(val && val!==CONFIG.window.end) els.endInput.dataset.userSet='true';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      preservePrefilledInputs();
      ['thr','startDate','endDate'].forEach(id => {
        const el=document.getElementById(id);
        if(!el) return;
        el.addEventListener('input', ()=>{
          if(id==='startDate' || id==='endDate') el.dataset.userSet='true';
          validateForm();
        });
      });
      if(els.runBtn) els.runBtn.addEventListener('click', runBacktest);
      if(els.form) els.form.addEventListener('submit', (e)=>{ e.preventDefault(); runBacktest(); });
      if(els.resetBtn) els.resetBtn.addEventListener('click', resetForm);
      hydrateWindow();
      validateForm();
    });
  </script>
</body>
</html>
