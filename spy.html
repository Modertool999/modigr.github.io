<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SPY Forecaster · Modi</title>
  <meta name="color-scheme" content="dark" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" defer></script>
  <!-- Inter: clean sans-serif -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ color-scheme:dark; --panel:#0b1713; --line:#1a2b24; --ink:#e8f3ed; --ui-font:"Inter","Segoe UI","Helvetica Neue",Arial,sans-serif; }
    *{ box-sizing:border-box; }
    body, button, input, select, textarea{ font-family:var(--ui-font) !important; }
    body{ margin:0; background:var(--panel); color:var(--ink); }
    a{ color:#8fe9b8; } a:hover{text-decoration:underline;}
    .wrap{ max-width:1040px; margin:0 auto; padding:0 16px; }

    header{ position:sticky; top:0; z-index:10; background:linear-gradient(180deg,rgba(18,87,64,.95),rgba(14,71,54,.92)); border-bottom:2px solid #0a2e23; box-shadow:0 2px 0 #062119; }
    .row{ display:flex; align-items:center; justify-content:space-between; padding:10px 0; }
    nav a{ margin-left:16px; color:#c9f3e0; } nav a.active{ color:#fff; text-shadow:0 1px 0 #083326; }

    .brand{ font-weight:800; letter-spacing:.3px; position:relative; display:inline-block; color:#fff; text-shadow:0 1px 0 #083326; }
    .brand::after{ content:""; position:absolute; left:0; bottom:-3px; height:3px; width:100%; background:linear-gradient(90deg,#87f6bf,#e4ffe4,#87f6bf); transform:scaleX(0); transform-origin:left; transition:transform .25s ease; }
    .brand:hover::after{ transform:scaleX(1); } .brand:hover{ transform: translateY(-1px) rotate(-.2deg); transition: transform .2s ease; }

    .card{ background:linear-gradient(180deg,#0f201a,#0b1713); border:1px solid var(--line); border-radius:14px; padding:18px; box-shadow:inset 0 1px 0 rgba(255,255,255,.03), 0 2px 0 #07140f; }
    .btn{ display:inline-block; padding:10px 14px; background:linear-gradient(180deg,#1bb774,#0e7c51); color:#fff; border-radius:10px; border:1px solid #0a5a3a; box-shadow:inset 0 1px 0 #54e0a4, 0 2px 0 #073e2a; }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }
    .btn-outline{ display:inline-block; padding:10px 14px; border:1px solid var(--line); border-radius:10px; color:var(--ink); background:#0d1b16; }
    .btn-outline:hover{ background:#0f201a; }

    input[type="text"], input[type="number"]{ width:100%; padding:10px; border-radius:10px; border:1px solid var(--line); background:#0f1d18; color:#fff; }

    .grid{ display:grid; gap:16px; }
    @media(min-width:900px){ .grid-4{ grid-template-columns:1fr 1fr 1fr auto; } .grid-4>*{ min-width:0; } }

    .note-red{ margin:8px 0 0 0; font-size:13px; color:#ffb3b3; border-left:3px solid #ff6b6b; padding-left:10px; }
    .alert{ display:none; border:1px solid #742a2a; background:#2a1616; color:#ffd8d8; padding:10px 12px; border-radius:10px; margin-bottom:10px; }
    .alert.show{ display:block; }
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <a class="brand" href="index.html">Modi Goldstein-Rosenfeld</a>
      <nav>
        <a href="index.html">Home</a>
        <a href="steam.html">Video Game Recommender</a>
        <a class="active" href="spy.html">SPY</a>
        <a href="https://github.com/Modertool999/spy-forecast" target="_blank" rel="noopener">Repo ↗</a>
      </nav>
    </div>
  </header>

  <main class="wrap" style="padding-top:20px;">
    <section class="card">
      <h1 style="margin:0 0 6px 0; font-size:28px;">S&amp;P 500 Next-Day Forecaster</h1>
      <p style="margin:0;">
        Backtest a long-or-cash strategy from engineered price features.
        <b>Start</b> and <b>End</b> must be within <b>2019-01-02</b> to <b>2025-10-01</b> (API window).
      </p>
      <p class="note-red">
        <b>Note:</b> This demo uses the free <code>yfinance</code> data source. Requests are rate-limited and availability may fluctuate with user activity.
        If it errors or times out, please try again shortly — this is outside my control.
      </p>
    </section>

    <section class="card" style="margin-top:18px;">
      <div id="alert" class="alert"></div>

      <form id="spyForm" novalidate>
        <div class="grid grid-4">
          <label>
            <div style="font-size:14px;">Threshold</div>
            <input id="thr" type="number" min="0" max="1" step="0.01" value="0.55" />
          </label>
          <label>
            <div style="font-size:14px;">Start (YYYY-MM-DD)</div>
            <!-- IMPORTANT: single backslashes in pattern, and prefilled default value -->
            <input id="startDate" type="text" pattern="^\d{4}-\d{2}-\d{2}$" value="2019-01-02" required />
            <div style="font-size:12px;color:#a9d7c5;margin-top:6px;">Default: 2019-01-02</div>
          </label>
          <label>
            <div style="font-size:14px;">End (YYYY-MM-DD)</div>
            <!-- Prefilled default value -->
            <input id="endDate" type="text" pattern="^\d{4}-\d{2}-\d{2}$" value="2025-10-01" required />
            <div style="font-size:12px;color:#a9d7c5;margin-top:6px;">Default: 2025-10-01</div>
          </label>
          <div style="display:flex; align-items:flex-end; gap:12px;">
            <!-- type=button so clicks always fire regardless of form validity UI -->
            <button id="runBacktest" type="button" class="btn">Run backtest</button>
            <button id="resetBacktest" type="button" class="btn-outline">Reset</button>
          </div>
        </div>
        <div id="btStatus" style="margin-top:8px; font-size:12px; color:#a9d7c5;" aria-live="polite"></div>
      </form>

      <div style="margin-top:14px;">
        <canvas id="equityChart" height="180"></canvas>
      </div>
      <div class="grid" style="grid-template-columns: repeat(4, 1fr); gap:12px; margin-top:12px;">
        <div class="btn-outline" style="padding:10px; border-radius:12px;"><div style="font-size:12px;color:#a9d7c5;">Total return</div><div id="statTR" style="font-weight:700; font-size:18px;">—</div></div>
        <div class="btn-outline" style="padding:10px; border-radius:12px;"><div style="font-size:12px;color:#a9d7c5;">CAGR</div><div id="statCAGR" style="font-weight:700; font-size:18px;">—</div></div>
        <div class="btn-outline" style="padding:10px; border-radius:12px;"><div style="font-size:12px;color:#a9d7c5;">Sharpe</div><div id="statSharpe" style="font-weight:700; font-size:18px;">—</div></div>
        <div class="btn-outline" style="padding:10px; border-radius:12px;"><div style="font-size:12px;color:#a9d7c5;">Max drawdown</div><div id="statMDD" style="font-weight:700; font-size:18px;">—</div></div>
      </div>
    </section>

    <section class="card" style="margin-top:18px;">
      <h2 style="margin:0 0 6px 0; font-size:22px;">How it works</h2>
      <ul style="margin:0;">
        <li>Daily SPY from Yahoo Finance since 2005.</li>
        <li>Lagged features (returns, RSI, overnight gap).</li>
        <li>Train/valid/test, long-or-cash strategy (2 bps trading costs).</li>
      </ul>
    </section>
  </main>

  <footer style="color:#a9d7c5; text-align:center; font-size:12px; padding:36px 0 60px; border-top:2px solid #0a2e23; margin-top:28px;">
    © <span id="y"></span> Modi Goldstein-Rosenfeld · SPY Forecaster
  </footer>

  <script>
    const CONFIG = {
      endpoints:{ spyForecast:'https://spy-forecast-modi-2-gka4h2cng6dhcvcf.westus-01.azurewebsites.net/api/spy-backtest' },
      requestTimeoutMs:20000,
      minDate:'2019-01-02',
      maxDate:'2025-10-01'
    };
    const $=(s)=>document.querySelector(s);
    document.getElementById('y').textContent=new Date().getFullYear();

    const setStatus=(m,ok=false)=>{ const el=$('#btStatus'); el.textContent=m||""; el.style.color= ok ? '#9ef5b2' : '#a9d7c5'; };
    const showAlert=(m)=>{ const a=$('#alert'); a.textContent=m; a.classList.add('show'); };
    const hideAlert=()=> $('#alert').classList.remove('show');
    const fetchWithTimeout=(url,opt={},ms=15000)=>{ const c=new AbortController(); const t=setTimeout(()=>c.abort(),ms); return fetch(url,{...opt,signal:c.signal}).finally(()=>clearTimeout(t)); };
    const isISO=(s)=>/^\d{4}-\d{2}-\d{2}$/.test(s);
    const withinWindow=(s)=>{ const d=new Date(s); return d>=new Date(CONFIG.minDate) && d<=new Date(CONFIG.maxDate); };

    // Attach handlers once DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      // Live validation
      ['thr','startDate','endDate'].forEach(id => document.getElementById(id).addEventListener('input', validateForm));
      document.getElementById('runBacktest').addEventListener('click', runBacktest);
      document.getElementById('spyForm').addEventListener('submit', (e)=>{ e.preventDefault(); runBacktest(); });
      // Validate once with the prefilled values
      validateForm();
    });

    function validateForm(){
      hideAlert();
      const thr=parseFloat($('#thr').value||'0.55');
      const start=($('#startDate').value||'').trim();
      const end=($('#endDate').value||'').trim();
      let ok=true, msg=[];

      if(!(thr>=0 && thr<=1)){ ok=false; msg.push('Threshold must be 0–1.'); }
      if(!isISO(start) || !isISO(end)){ ok=false; msg.push('Start/End must be YYYY-MM-DD.'); }
      if(isISO(start) && isISO(end) && new Date(start) > new Date(end)){ ok=false; msg.push('Start must be on or before End.'); }
      if(isISO(start) && !withinWindow(start)){ ok=false; msg.push('Start must be within '+CONFIG.minDate+' to '+CONFIG.maxDate+'.'); }
      if(isISO(end) && !withinWindow(end)){ ok=false; msg.push('End must be within '+CONFIG.minDate+' to '+CONFIG.maxDate+'.'); }

      // We control the enable/disable state
      document.getElementById('runBacktest').disabled = !ok;
      if(!ok) showAlert(msg.join(' '));
      return ok;
    }

    let chart;
    function ensureChart(){
      if(chart) return chart;
      const canvas=document.getElementById('equityChart'); if(!canvas){ console.error('Canvas missing'); return null; }
      const ctx=canvas.getContext('2d');
      const grad=ctx.createLinearGradient(0,0,0,200); grad.addColorStop(0,'rgba(27,183,116,0.28)'); grad.addColorStop(1,'rgba(27,183,116,0.00)');
      chart=new Chart(ctx,{ type:'line',
        data:{ labels:[], datasets:[{ label:'Equity (\u00D7)', data:[], borderColor:'#1bb774', backgroundColor:grad, fill:true, borderWidth:2, pointRadius:0, tension:0.18 }] },
        options:{ responsive:true, animation:{duration:220}, interaction:{mode:'index', intersect:false},
          scales:{ y:{ beginAtZero:false, grid:{ color:'rgba(255,255,255,.08)' }}, x:{ display:false }},
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>'\u00D7 '+(c.parsed?.y??0).toFixed(3) } } }
      }});
      return chart;
    }

    function looksRateLimited(status, txt){
      if(status===429 || status===503 || status===502) return true;
      if(typeof txt==='string' && /rate limit|too many requests|temporar/i.test(txt)) return true;
      return false;
    }

    async function runBacktest(){
      if(!validateForm()) return;
      const btn=$('#runBacktest'); const ch=ensureChart();
      const thr=parseFloat($('#thr').value||'0.55');
      const start=($('#startDate').value||'').trim();
      const end=($('#endDate').value||'').trim();

      try{
        btn.disabled=true; setStatus('Running backtest…');
        const res=await fetchWithTimeout(CONFIG.endpoints.spyForecast,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ threshold:thr, start, end })
        }, CONFIG.requestTimeoutMs);

        const txt=await res.text();
        if(!res.ok){
          if(looksRateLimited(res.status, txt)){
            showAlert('Backtest temporarily unavailable due to upstream data rate limits (free yfinance). Please try again in a minute.');
          }else{
            showAlert('Backtest failed. Please check the date window and try again. (HTTP '+res.status+')');
          }
          setStatus(''); return;
        }
        const data=JSON.parse(txt);
        const eq=Array.isArray(data.equity)? data.equity:[];
        if(eq.length===0){ setStatus('No equity data for that window.'); return; }

        ch.data.labels=eq.map((_,i)=>i);
        ch.data.datasets[0].data=eq;
        ch.update();

        const pct=(x)=> (Number(x)||0).toFixed(2);
        document.getElementById('statTR').textContent   = `${pct(data.total_ret)}%`;
        document.getElementById('statCAGR').textContent = `${pct(data.cagr)}%`;
        document.getElementById('statSharpe').textContent = data.sharpe!=null? pct(data.sharpe) : '—';
        document.getElementById('statMDD').textContent    = data.max_drawdown!=null? `${pct(data.max_drawdown)}%` : '—';
        setStatus('Done.', true);
      }catch(e){
        if(e.name==='AbortError') showAlert('Request timed out. Try again.');
        else showAlert(e.message || 'Request failed.');
        setStatus('');
      }finally{ btn.disabled=false; }
    }
  </script>
</body>
</html>
