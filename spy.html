<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SPY Forecaster · Modi</title>
  <meta name="color-scheme" content="dark" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script>tailwind={config:{darkMode:'class',theme:{extend:{fontFamily:{sans:['Inter','ui-sans-serif','system-ui','Segoe UI','Helvetica Neue','Arial']}}}}};</script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <style>
    body { background:#0b0b0e; color:#e7e7ea; }
    .card { background:#121217; border:1px solid #27272a; border-radius:1.25rem; }
    .btn { background:#5b55ee; color:#fff; }
    .btn:hover { background:#6c69f3; }
    .outline { border:1px solid #2f2f37; }
    a { color:#b8befe; }
  </style>
</head>
<body>
  <header class="sticky top-0 z-40 backdrop-blur bg-black/30 border-b border-zinc-800">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="index.html" class="font-extrabold tracking-tight text-lg">Modi</a>
      <nav class="hidden sm:flex items-center gap-6 text-sm text-zinc-400">
        <a href="index.html">Home</a>
        <a href="steam.html">Steam</a>
        <a href="spy.html" class="text-zinc-200">SPY</a>
        <a href="https://github.com/Modertool999/spy-forecast" target="_blank">Repo ↗</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-10">
    <section class="card p-6">
      <h1 class="text-3xl font-bold">S&P 500 Next-Day Forecaster</h1>
      <p class="text-sm text-zinc-300 mt-1 max-w-2xl">
        Logistic-regression on engineered price features. Backtest a long-or-cash strategy and see the equity curve and stats.
        <strong>Start</strong> and <strong>End</strong> dates are required; defaults are provided.
      </p>
    </section>

    <section class="mt-6 card p-6">
      <div id="alert" class="hidden mb-4 rounded-lg border border-red-800 bg-red-950/40 px-3 py-2 text-sm text-red-300"></div>

      <form id="spyForm" class="space-y-4" novalidate>
        <div class="grid sm:grid-cols-4 gap-4">
          <label class="text-sm">Threshold
            <input id="thr" type="number" min="0" max="1" step="0.01" value="0.55"
                   class="mt-1 rounded-xl outline bg-transparent px-3 py-2 w-28" required />
          </label>

          <label class="text-sm">Start (YYYY-MM-DD)
            <input id="startDate" type="text" pattern="^\\d{4}-\\d{2}-\\d{2}$" required
                   class="mt-1 rounded-xl outline bg-transparent px-3 py-2 w-full" />
            <div class="text-xs text-zinc-400 mt-1">Default: 2019-01-01</div>
          </label>

          <label class="text-sm">End (YYYY-MM-DD)
            <input id="endDate" type="text" pattern="^\\d{4}-\\d{2}-\\d{2}$" required
                   class="mt-1 rounded-xl outline bg-transparent px-3 py-2 w-full" />
            <div class="text-xs text-zinc-400 mt-1">Default: today</div>
          </label>

          <div class="flex items-end gap-2">
            <button id="runBacktest" type="submit" class="btn rounded-xl px-4 py-2 disabled:opacity-50">Run backtest</button>
            <button id="resetBacktest" type="button" class="rounded-xl px-4 py-2 outline">Reset</button>
          </div>
        </div>
        <div class="flex items-center gap-2 text-xs text-zinc-400" aria-live="polite"><span id="btStatus"></span></div>
      </form>

      <div class="mt-5">
        <canvas id="equityChart" height="170"></canvas>
      </div>
      <div id="btStatsWrap" class="mt-4 grid sm:grid-cols-4 gap-3">
        <div class="rounded-xl outline p-3"><div class="text-xs text-zinc-400">Total return</div><div id="statTR" class="text-lg font-semibold">—</div></div>
        <div class="rounded-xl outline p-3"><div class="text-xs text-zinc-400">CAGR</div><div id="statCAGR" class="text-lg font-semibold">—</div></div>
        <div class="rounded-xl outline p-3"><div class="text-xs text-zinc-400">Sharpe</div><div id="statSharpe" class="text-lg font-semibold">—</div></div>
        <div class="rounded-xl outline p-3"><div class="text-xs text-zinc-400">Max drawdown</div><div id="statMDD" class="text-lg font-semibold">—</div></div>
      </div>
    </section>

    <section class="mt-6 card p-6">
      <h2 class="text-lg font-semibold">How it works</h2>
      <ul class="list-disc pl-5 text-sm mt-2 space-y-1 text-zinc-300">
        <li>Daily SPY from Yahoo Finance since 2005.</li>
        <li>Lagged features (returns, RSI, overnight gap).</li>
        <li>Train/valid/test, long-or-cash strategy (2 bps trading costs).</li>
      </ul>
    </section>
  </main>

  <footer class="py-10 text-center text-xs text-zinc-500">© <span id="y"></span> Modi Goldstein-Rosenfeld · SPY Forecaster</footer>

  <script>
    const CONFIG = {
      endpoints: {
        spyForecast: 'https://spy-forecast-modi-2-gka4h2cng6dhcvcf.westus-01.azurewebsites.net/api/spy-backtest'
      },
      requestTimeoutMs: 20000
    };

    const $=(s)=>document.querySelector(s);
    $('#y').textContent = new Date().getFullYear();

    // Prefill required defaults
    (function setDefaults(){
      const startDefault = '2019-01-01';
      const today = new Date(); const endDefault = today.toISOString().slice(0,10);
      $('#startDate').value = startDefault;
      $('#endDate').value = endDefault;
    })();

    // Helpers
    const setStatus=(el,msg,ok=false)=>{ el.textContent=msg; el.className=`text-xs ${ok? 'text-green-400':'text-zinc-400'}` };
    const showAlert=(msg)=>{ const a=$('#alert'); a.textContent=msg; a.classList.remove('hidden'); };
    const hideAlert=()=> $('#alert').classList.add('hidden');
    const fetchWithTimeout=(url,opt={},ms=15000)=>{ const c=new AbortController(); const t=setTimeout(()=>c.abort(),ms); return fetch(url,{...opt,signal:c.signal}).finally(()=>clearTimeout(t)); };
    const isISO=(s)=>/^\d{4}-\d{2}-\d{2}$/.test(s);

    // Chart
    let chart;
    function ensureChart(){
      if(chart) return chart;
      const ctx=document.getElementById('equityChart').getContext('2d');
      const grad=ctx.createLinearGradient(0,0,0,220); grad.addColorStop(0,'rgba(91,85,238,0.28)'); grad.addColorStop(1,'rgba(91,85,238,0.00)');
      chart=new Chart(ctx,{
        type:'line',
        data:{ labels:[], datasets:[{ label:'Equity (×)', data:[], borderColor:'#5b55ee', backgroundColor:grad, fill:true, borderWidth:2, pointRadius:0, tension:0.18 }] },
        options:{ responsive:true, animation:{duration:220}, interaction:{mode:'index', intersect:false},
          scales:{ y:{ beginAtZero:false, grid:{ color:'rgba(255,255,255,.08)' }}, x:{ display:false }},
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:c=>`× ${c.parsed.y.toFixed(3)}` }}}
        }
      });
      return chart;
    }

    async function runBacktest(){
      hideAlert();
      const status=$('#btStatus');
      const btn=$('#runBacktest');
      const thr=parseFloat($('#thr').value || '0.55');
      const start=($('#startDate').value||'').trim();
      const end=($('#endDate').value||'').trim();

      // Validate required inputs
      if (!isFinite(thr) || thr < 0 || thr > 1) { showAlert('Threshold must be a number between 0 and 1.'); return; }
      if (!isISO(start) || !isISO(end)) { showAlert('Start and End must be YYYY-MM-DD.'); return; }
      if (new Date(start) > new Date(end)) { showAlert('Start date must be on or before End date.'); return; }

      if(!CONFIG.endpoints.spyForecast){ showAlert('Backend endpoint not configured.'); return; }

      const ch=ensureChart();
      try{
        btn.disabled=true; setStatus(status,'Running backtest…');
        const body={ threshold: thr, start, end };
        const res=await fetchWithTimeout(CONFIG.endpoints.spyForecast,{
          method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body)
        }, CONFIG.requestTimeoutMs);

        if(!res.ok){ const txt=await res.text(); throw new Error(`HTTP ${res.status}: ${txt.slice(0,200)}`); }

        const data=await res.json();
        const eq=Array.isArray(data.equity)? data.equity:[];
        if(eq.length===0){ setStatus(status,'No equity data returned for the selected dates.'); return; }

        ch.data.labels=eq.map((_,i)=>i); ch.data.datasets[0].data=eq; ch.update();
        const pct=(x)=> (Number(x)||0).toFixed(2);
        $('#statTR').textContent   = `${pct(data.total_ret)}%`;
        $('#statCAGR').textContent = `${pct(data.cagr)}%`;
        $('#statSharpe').textContent = data.sharpe!=null? pct(data.sharpe) : '—';
        $('#statMDD').textContent    = data.max_drawdown!=null? `${pct(data.max_drawdown)}%` : '—';
        setStatus(status,'Done.',true);
      }catch(e){ console.error(e); showAlert(e.message || 'Request failed.'); setStatus(status,''); }
      finally{ btn.disabled=false; }
    }

    document.getElementById('spyForm').addEventListener('submit', (e)=>{ e.preventDefault(); runBacktest(); });

    document.getElementById('resetBacktest').addEventListener('click', ()=>{
      hideAlert();
      const ch=ensureChart(); ch.data.labels=[]; ch.data.datasets[0].data=[]; ch.update();
      ['statTR','statCAGR','statSharpe','statMDD'].forEach(id=> $('#'+id).textContent='—'); $('#btStatus').textContent='';
      // Reset to defaults again
      (function setDefaults(){
        const startDefault = '2019-01-01';
        const today = new Date(); const endDefault = today.toISOString().slice(0,10);
        $('#startDate').value = startDefault;
        $('#endDate').value = endDefault;
        $('#thr').value = 0.55;
      })();
    });
  </script>
</body>
</html>
